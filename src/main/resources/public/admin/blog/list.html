<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
</head>
<body>
    <div id="app">
        <template>
            <el-form ref="form" :model="form" label-width="450px">
                <el-input v-model="form.blogTitle" placeholder="请输入标题关键词" style="width: 200px;"></el-input>
                <el-select v-model="form.menuId" placeholder="所属菜单">
                    <el-option
                            v-for="item in menus"
                            :key="item.id"
                            :label="item.name"
                            :value="item.id">
                    </el-option>
                </el-select>
                <el-select v-model="form.tagId" placeholder="分类">
                    <el-option
                            v-for="item in tags"
                            :key="item.id"
                            :label="item.name"
                            :value="item.id">
                    </el-option>
                </el-select>
                <el-button type="primary" @click="search">搜索</el-button>
                <el-button type="primary" @click="add">新建</el-button>
            </el-form>

            <el-table :data="tableData" border style="width: 100%;margin-top: 10px;"
                      :row-key="getRowKeys"
                      :expand-row-keys="expands"
                      @expand-change="expandChange">
                <el-table-column fixed prop="id" label="ID">
                </el-table-column>
                <el-table-column prop="title" label="标题">
                </el-table-column>
                <el-table-column prop="menuName" label="所属菜单">
                </el-table-column>
                <el-table-column prop="tagName" label="分类">
                </el-table-column>
                <el-table-column prop="statu" label="状态">
                </el-table-column>
                <el-table-column prop="createTime" label="创建时间">
                </el-table-column>
                <el-table-column prop="lookNum" label="浏览量">
                </el-table-column>
                <el-table-column prop="commentNum" label="评论量">
                </el-table-column>
                <el-table-column type="expand" @click="handleConnectionSearch(scope.row)">
                    <template slot-scope="scopeComment1">
                        <el-table :data="commentList" border style="width: 100%">
                            <el-table-column prop="commentTime"  label="评论时间"></el-table-column>
                            <el-table-column prop="content" label="评论内容"></el-table-column>
                            <el-table-column prop="statu" label="状态"></el-table-column>
                            <el-table-column fixed="right" label="操作" >
                                <template slot-scope="scopeComment2">
                                    <el-button v-if="scopeComment2.row.statu == '有效'" @click="deleteComment(scopeComment2.row.id)" type="text" size="small">删除</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                        <el-pagination
                                @size-change="handleCommentSizeChange"
                                @current-change="handleCommentCurrentChange"
                                :current-page="commentForm.pageNo"
                                :page-size="commentForm.pageSize"
                                :total="commentForm.totals">
                        </el-pagination>
                    </template>
                </el-table-column>
                <el-table-column fixed="right" label="操作" >
                    <template slot-scope="scope">
                        <el-button @click="edit(scope.row.id)" type="text" size="small">编辑</el-button>
                        <el-button @click="look(scope.row.id)" type="text" size="small">预览</el-button>
                        <el-button v-if="scope.row.statu == '有效'" @click="deleteById(scope.row.id)" type="text" size="small">删除</el-button>
                    </template>
                </el-table-column>
            </el-table>
            <el-pagination
                    @size-change="handleSizeChange"
                    @current-change="handleCurrentChange"
                    :current-page="form.pageNo"
                    :page-size="form.pageSize"
                    :total="totals">
            </el-pagination>
        </template>
    </div>
</body>
    <script type="text/javascript" src="../../js/vue.js"></script>
    <script type="text/javascript" src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script>
        var Main = {
            methods: {
                deleteComment:function(commentId){
                    var self = this;
                    var params = new URLSearchParams();
                    params.append("commentId",commentId);
                    axios.post("/index/comment/delete",params).then(function(response){
                        console.log(response);
                        self.$message({
                            showClose: true,
                            message: response.data.success ? "删除成功" : "删除失败",
                            type: response.data.success ? 'success' : 'error'
                        });
                        self.getComment();
                    })
                },
                restComment:function(){
                    this.commentList = [];
                    this.commentForm.blogId = "";
                    this.commentForm.pageNo = 1;
                    this.commentForm.pageSize = 10;
                    this.commentForm.totals = 0;
                },
                expandChange:function(row,expandedRows){
                    this.restComment();
                    if(this.expands.indexOf(row.id)>=0){
                        //收起当前行
                        this.expands.shift();
                        return;
                    }
                    this.commentForm.blogId = row.id;
                    this.getComment();
                    if (expandedRows.length > 1) {
                        //只展开当前选项
                        expandedRows.shift();
                    }
                },
                getRowKeys:function(row) {
                     return row.id
                },
                getComment:function(){
                    var self = this;
                    self.commentList = [];
                    axios.post("/index/comment/getComment",self.commentForm).then(function(response){
                        if(response.data.list != null){
                            for(var i = 0;i<response.data.list.length;i++){
                                var comment = new Object();
                                comment.id = response.data.list[i].id;
                                comment.commentTime = response.data.list[i].createTime;
                                comment.content = response.data.list[i].content;
                                comment.statu = response.data.list[i].statu == 1 ? "有效" : "已删除";
                                self.commentList.push(comment);
                            }
                            self.commentForm.totals = response.data.total;
                            self.commentForm.pageSize = response.data.pageSize;
                            self.commentForm.pageNo = response.data.pageNum;
                        }
                    })
                },
                look:function(id){
                    window.open("/blog/blog.html?id="+id);
                },
                add:function(){
                    window.location.href="add.html";
                },
                edit:function(id){
                    window.location.href="add.html?id="+id;
                },
                search:function(){
                  this.loadData();
                },
                loadData:function(){
                    var self = this;
                    self.tableData = [];
                    axios.post("/adminBlog/findAll",this.form).then(function(response){
                        console.log(response);
                        if(response != null && response.data != null){
                            var list = response.data.list;
                            for(var i = 0;i<list.length;i++){
                                var info = new Object();
                                info.id = list[i].id;
                                info.title = list[i].title;
                                info.menuName = list[i].menuName;
                                info.tagName = list[i].tagName;
                                info.createTime = list[i].createTime;
                                info.statu = list[i].statu === 1 ? "有效" : "删除";
                                info.commentNum = list[i].commentNum == null ? 0 : list[i].commentNum;
                                self.tableData.push(info);
                            }
                            self.totals = response.data.total;
                            self.pageSize = response.data.pageSize;
                            self.pageNo = response.data.pageNum;
                        }
                    });
                },
                loadParam:function(){
                    var self = this;
                    axios.post("/adminBlog/initData",{}).then(function (value) {
                        console.log(value);
                        if(value.data.content != null){
                            self.menus = value.data.content.menus;
                            self.tags = value.data.content.tags;

                        }
                    })
                },
                deleteById:function(id){
                    var self = this;
                    axios.get("/tags/deleteById",{params:{"id":id}}).then(function(response){
                        console.log(response);
                        if(response.data){
                           self.$message({
                              showClose: true,
                              message: '删除成功',
                              type: 'success'
                            });
                            self.loadData();
                        }
                    });
                },
                handleSizeChange:function(val) {
                    this.form.pageSize = val;
                    this.loadData();
                },
                handleCurrentChange:function(val) {
                    this.form.pageNo = val;
                    this.loadData();
                },
                handleCommentSizeChange:function(val) {
                    this.commentForm.pageSize = val;
                    this.getComment();
                },
                handleCommentCurrentChange:function(val) {
                    this.commentForm.pageNo = val;
                    this.getComment();
                }
            },
            data() {
                return {
                    expands:[],
                    commentList:[], //评论内容
                    tableData: [],
                    totals:0,
                    menus:[],
                    tags:[],
                    commentForm:{
                      blogId:"",
                      pageNo:1,
                      pageSize:10,
                      totals:0,
                      isAdmin:1
                    },
                    form:{
                        pageSize:10,
                        pageNo:1,
                        menuId:null,
                        tagId:null,
                        blogTitle:null
                    }

                }
            },
            mounted:function(){
                this.loadParam();
                this.loadData();
            }
        }
        var Ctor = Vue.extend(Main)
        new Ctor().$mount('#app')
    </script>
</html>